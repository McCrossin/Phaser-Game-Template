name: Template Quality Check

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]
    workflow_dispatch:
        inputs:
            skip_e2e:
                description: 'Skip E2E tests'
                required: false
                default: 'false'
            verbose:
                description: 'Enable verbose output'
                required: false
                default: 'false'

env:
    NODE_VERSION: '22.17.1'
    TEMPLATE_VALIDATION_TIMEOUT: 600000

jobs:
    template-quality-validation:
        name: Template Quality Validation
        runs-on: ubuntu-latest
        timeout-minutes: 20

        strategy:
            matrix:
                node-version: ['22.17.1']
                test-suite: [unit, integration, e2e, full]
            fail-fast: false

        steps:
            - name: 📥 Checkout Repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: 🔧 Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'

            - name: 📦 Install Dependencies
              run: |
                  npm ci
                  npx playwright install chromium

            - name: 🧹 Clean Previous Builds
              run: |
                  npm run clean
                  rm -rf dist coverage test-results

            - name: 🔍 TypeScript Type Check
              run: npm run typecheck

            - name: 🎯 ESLint Code Quality
              run: npm run lint

            - name: 🧪 Unit Tests
              if: matrix.test-suite == 'unit' || matrix.test-suite == 'full'
              run: |
                  npm run test:coverage
                  echo "Unit tests completed for Node.js ${{ matrix.node-version }}"

            - name: 🔗 Integration Tests
              if: matrix.test-suite == 'integration' || matrix.test-suite == 'full'
              run: |
                  if [ -d "testing/integration" ]; then
                    npm run test:run -- testing/integration/**
                    echo "Integration tests completed"
                  else
                    echo "No integration tests found - skipping"
                  fi

            - name: 🎭 E2E Tests
              if: (matrix.test-suite == 'e2e' || matrix.test-suite == 'full') && github.event.inputs.skip_e2e != 'true'
              run: |
                  npm run build
                  npm run test:e2e

            - name: ⚡ Performance Validation
              if: matrix.test-suite == 'full'
              run: |
                  npm run performance:check || echo "Performance check completed with warnings"

            - name: 💚 Health Checks
              if: matrix.test-suite == 'full'
              run: |
                  npm run health:check || echo "Health check completed with warnings"

            - name: 🔨 Build Validation
              run: |
                  npm run build
                  echo "Build validation completed for Node.js ${{ matrix.node-version }}"

            - name: 📊 Upload Coverage Reports
              if: matrix.test-suite == 'unit' || matrix.test-suite == 'full'
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report-node${{ matrix.node-version }}
                  path: coverage/
                  retention-days: 7

            - name: 📋 Upload Test Results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: test-results-${{ matrix.test-suite }}-node${{ matrix.node-version }}
                  path: |
                      test-results/
                      playwright-report/
                  retention-days: 7
