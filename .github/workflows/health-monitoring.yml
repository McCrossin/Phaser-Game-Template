name: Health Monitoring

on:
    schedule:
        # Run weekly health check on Sundays at 6 AM UTC
        - cron: '0 6 * * 0'
    push:
        branches: [main]
        paths:
            - 'tools/monitoring/**'
            - '.github/workflows/health-monitoring.yml'
    workflow_dispatch:
        inputs:
            full_scan:
                description: 'Run full comprehensive health scan'
                required: false
                default: 'false'
                type: boolean

jobs:
    health-check:
        runs-on: ubuntu-latest

        permissions:
            contents: read
            issues: write # For creating health report issues if needed

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22.17.1'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Compile monitoring tools
              run: |
                  echo "Compiling TypeScript monitoring tools..."
                  npx tsc tools/monitoring/health-check.ts --outDir tools/monitoring/compiled --target es2022 --module node16 --moduleResolution node16 --allowSyntheticDefaultImports
                  npx tsc tools/monitoring/technical-debt-tracker.ts --outDir tools/monitoring/compiled --target es2022 --module node16 --moduleResolution node16 --allowSyntheticDefaultImports

            - name: Run Framework Health Check
              id: health_check
              run: |
                  echo "Running framework health check..."
                  node tools/monitoring/compiled/health-check.js > health-check-output.txt 2>&1
                  echo "health_check_exit_code=$?" >> $GITHUB_OUTPUT
              continue-on-error: true

            - name: Run Technical Debt Scan
              id: debt_scan
              run: |
                  echo "Running technical debt scan..."
                  node tools/monitoring/compiled/technical-debt-tracker.js > debt-scan-output.txt 2>&1
                  echo "debt_scan_exit_code=$?" >> $GITHUB_OUTPUT
              continue-on-error: true

            - name: Generate Health Report
              run: |
                  echo "# 📊 Weekly Health Report - $(date)" > health-report.md
                  echo "" >> health-report.md
                  echo "## 🔍 Framework Health Check" >> health-report.md
                  echo "" >> health-report.md
                  echo '```' >> health-report.md
                  cat health-check-output.txt >> health-report.md
                  echo '```' >> health-report.md
                  echo "" >> health-report.md
                  echo "## 🏗️ Technical Debt Analysis" >> health-report.md
                  echo "" >> health-report.md
                  echo '```' >> health-report.md
                  cat debt-scan-output.txt >> health-report.md
                  echo '```' >> health-report.md
                  echo "" >> health-report.md
                  echo "## 📈 Health Trends" >> health-report.md
                  echo "" >> health-report.md
                  echo "- **Health Check Status**: $(if [ "${{ steps.health_check.outputs.health_check_exit_code }}" = "0" ]; then echo "✅ Passed"; else echo "❌ Failed"; fi)" >> health-report.md
                  echo "- **Technical Debt Status**: $(if [ "${{ steps.debt_scan.outputs.debt_scan_exit_code }}" = "0" ]; then echo "✅ Acceptable"; else echo "⚠️ Needs Attention"; fi)" >> health-report.md
                  echo "- **Report Generated**: $(date -u)" >> health-report.md
                  echo "- **Environment**: GitHub Actions CI" >> health-report.md
                  echo "" >> health-report.md
                  echo "---" >> health-report.md
                  echo "*This report was automatically generated by the Health Monitoring workflow*" >> health-report.md

            - name: Upload Health Report
              uses: actions/upload-artifact@v4
              with:
                  name: health-report-${{ github.run_number }}
                  path: |
                      health-report.md
                      health-check-output.txt
                      debt-scan-output.txt
                      technical-debt-report.json
                  retention-days: 30

            - name: Check Health Status
              run: |
                  health_exit_code="${{ steps.health_check.outputs.health_check_exit_code }}"
                  debt_exit_code="${{ steps.debt_scan.outputs.debt_scan_exit_code }}"

                  echo "Health check exit code: $health_exit_code"
                  echo "Technical debt scan exit code: $debt_exit_code"

                  if [ "$health_exit_code" != "0" ] || [ "$debt_exit_code" != "0" ]; then
                    echo "❌ Health monitoring detected issues!"
                    echo "Review the health report artifact for details."
                    
                    # In a real scenario, you might want to create an issue or send notifications
                    # For now, we'll just fail the workflow to get attention
                    exit 1
                  else
                    echo "✅ All health checks passed!"
                  fi

    performance-baseline:
        runs-on: ubuntu-latest
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.full_scan == 'true'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22.17.1'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build project
              run: npm run build

            - name: Run performance tests
              run: npm run test:performance
              continue-on-error: true

            - name: Generate performance baseline
              run: |
                  echo "# 🎯 Performance Baseline Report" > performance-baseline.md
                  echo "" >> performance-baseline.md
                  echo "Generated on: $(date -u)" >> performance-baseline.md
                  echo "Environment: GitHub Actions CI" >> performance-baseline.md
                  echo "Node.js version: $(node --version)" >> performance-baseline.md
                  echo "npm version: $(npm --version)" >> performance-baseline.md
                  echo "" >> performance-baseline.md

                  # Build time
                  echo "## Build Performance" >> performance-baseline.md
                  echo "" >> performance-baseline.md
                  build_start=$(date +%s%N)
                  npm run build >/dev/null 2>&1
                  build_end=$(date +%s%N)
                  build_time=$(( (build_end - build_start) / 1000000 ))
                  echo "- Build time: ${build_time}ms" >> performance-baseline.md

                  # Bundle size
                  if [ -d "dist" ]; then
                    bundle_size=$(du -sh dist | cut -f1)
                    echo "- Bundle size: $bundle_size" >> performance-baseline.md
                  fi

                  echo "" >> performance-baseline.md
                  echo "## Test Performance" >> performance-baseline.md
                  echo "" >> performance-baseline.md

                  # Test execution time
                  test_start=$(date +%s%N)
                  npm test >/dev/null 2>&1 || true
                  test_end=$(date +%s%N)
                  test_time=$(( (test_end - test_start) / 1000000 ))
                  echo "- Test execution time: ${test_time}ms" >> performance-baseline.md

                  echo "" >> performance-baseline.md
                  echo "---" >> performance-baseline.md
                  echo "*Baseline established for CI environment performance tracking*" >> performance-baseline.md

            - name: Upload performance baseline
              uses: actions/upload-artifact@v4
              with:
                  name: performance-baseline-${{ github.run_number }}
                  path: performance-baseline.md
                  retention-days: 90
